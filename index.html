<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talavera Hub | Responsive Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #0d6efd; --dark-bg: #1a1c23; --card-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; font-size: 0.85rem; color: #333; margin: 0; }

        /* FIXED LOADING OVERLAY FOR MOBILE */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; color: white;
            padding: 20px; text-align: center;
        }
        #loadMsg {
            max-width: 90%;
            word-wrap: break-word;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Header & Navigation */
        .main-header { background: var(--dark-bg); color: white; padding: 1rem; position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--primary); }
        .header-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; width: 100%; }
        @media (min-width: 768px) { 
            .header-controls { margin-top: 0; width: auto; }
        }

        /* Stats Grid - Responsive */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            margin-top: 15px; 
        }
        @media (min-width: 768px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1200px) { .stats-grid { grid-template-columns: repeat(6, 1fr); } }

        .stat-card { background: #fff; padding: 12px; border-radius: 10px; box-shadow: var(--card-shadow); border-bottom: 4px solid #dee2e6; }
        .stat-card b { font-size: 0.65rem; color: #6c757d; text-transform: uppercase; display: block; }
        .stat-card span { font-size: 1.25rem; font-weight: 800; display: block; }

        /* Area Containers */
        .area-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        @media (min-width: 992px) { .area-container { flex-direction: row; } }

        .town-section { background: white; border-radius: 12px; padding: 15px; flex: 1; box-shadow: var(--card-shadow); border-top: 5px solid #dee2e6; }
        .grid-wrapper { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 6px; margin-top: 10px; }
        
        .town-item { 
            border: 1px solid #edf2f7; border-radius: 6px; display: flex; 
            justify-content: space-between; padding: 6px 8px; font-size: 0.75rem; background: #fafbfc;
        }
        .town-item.hot { background: #fff1f2; color: #e11d48; font-weight: bold; border-color: #fecaca; }

        /* Tables */
        .table-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: var(--card-shadow); overflow: hidden; }
        .scroll-area { max-height: 400px; overflow-x: auto; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; margin-top: 10px; }
        .table { min-width: 600px; margin-bottom: 0; }
        .table thead th { background: #2d3748; color: white; position: sticky; top: 0; font-size: 0.7rem; padding: 10px; z-index: 10; }
        
        .count-badge { background: var(--primary); color: white; padding: 3px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .search-box { border-radius: 20px; border: 1px solid #4a5568; background: #2d3748; color: white; padding: 6px 15px; flex-grow: 1; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="loader"></div>
    <div id="loadMsg">Consolidating Multi-File Data...</div>
</div>

<header class="main-header">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h6 class="fw-bold m-0">TALAVERA HUB DASHBOARD</h6>
            <div class="header-controls">
                <input type="text" id="tSearch" class="search-box" placeholder="Find town...">
                <button class="btn btn-primary btn-sm px-3 fw-bold" onclick="$('#file').click()">UPLOAD</button>
                <input id="file" type="file" accept=".csv, .xlsx, .xls" multiple class="d-none" />
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card border-danger"><b>Total Ops</b><span id="c-ops" class="text-danger">0</span></div>
            <div class="stat-card border-success"><b>Received</b><span id="c-rec" class="text-success">0</span></div>
            <div class="stat-card border-warning"><b>Transporting</b><span id="c-ing" class="text-warning">0</span></div>
            <div class="stat-card border-info"><b>Transported</b><span id="c-ed" class="text-info">0</span></div>
            <div class="stat-card border-primary"><b>SD Area</b><span id="c-sdo" class="text-primary">0</span></div>
            <div class="stat-card border-dark"><b>TVR Area</b><span id="c-tvr" class="text-dark">0</span></div>
        </div>
    </div>
</header>

<main class="container-fluid py-3">
    <div class="area-container">
        <div class="town-section" style="border-top-color: #0d6efd;">
            <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold text-primary">SD POOL</span>
                <span class="count-badge" id="q-sdo-p">0</span>
            </div>
            <div id="grid-sdo" class="grid-wrapper"></div>
        </div>
        <div class="town-section" style="border-top-color: #dc3545;">
            <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold text-danger">UPPER TVR</span>
                <span class="count-badge bg-danger" id="q-up-p">0</span>
            </div>
            <div id="grid-up" class="grid-wrapper"></div>
        </div>
        <div class="town-section" style="border-top-color: #212529;">
            <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold text-dark">LOWER TVR</span>
                <span class="count-badge bg-dark" id="q-low-p">0</span>
            </div>
            <div id="grid-low" class="grid-wrapper"></div>
        </div>
    </div>

    <div class="table-card" style="border-top-color: #0d6efd;">
        <div class="d-flex justify-content-between">
            <span class="fw-bold text-primary">SD AREA (ALL)</span>
            <span id="q-sdo-t" class="count-badge">0</span>
        </div>
        <div class="scroll-area"><table id="t-sdo" class="table table-sm table-hover"><thead><tr><th>Order ID</th><th>Town</th><th>Sort</th><th>Status</th><th>Station</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="table-card" style="border-top-color: #212529;">
        <div class="d-flex justify-content-between">
            <span class="fw-bold text-dark">TALAVERA AREA (ALL)</span>
            <span id="q-tvr-t" class="count-badge bg-dark">0</span>
        </div>
        <div class="scroll-area"><table id="t-tvr" class="table table-sm table-hover"><thead><tr><th>Order ID</th><th>Town</th><th>Sort</th><th>Status</th><th>Station</th></tr></thead><tbody></tbody></table></div>
    </div>
</main>

<script>
$(function () {
    const STATIONS = { SOC: "SOC 4", HUB: "Talavera Hub" };
    const UPPER_KEY = ["MABUHAY", "COLLADO", "CABUBULAONAN", "BANTUG HACIENDA", "SAN PASCUAL", "BAGONG SILANG", "LOMBOY", "SICSICAN MATANDA", "TABACAO", "CASULUCAN ESTE", "TAGAYTAY", "BULAC", "PANTOC BULAC", "BANTUG HAMOG", "BASANG HAMOG", "BAKAL I", "BAKAL II", "BAKAL III", "MATINGKIS"];

    const extractData = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: "array" });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                resolve(json.map(r => {
                    let row = {};
                    for (let k in r) { row[k.toLowerCase().trim()] = r[k]; }
                    return {
                        oid: row["order id"] || "",
                        sort: String(row["sort code name"] || "").toUpperCase(),
                        town: String(row["town name"] || "UNKNOWN").toUpperCase(),
                        stat: String(row["status"] || ""),
                        curr: String(row["current station"] || "").trim(),
                        dest: String(row["destination station"] || "").trim()
                    };
                }));
            };
            reader.readAsArrayBuffer(file);
        });
    };

    const processFiles = async (files) => {
        if (!files.length) return;
        $("#loadingOverlay").css("display", "flex");
        
        let combinedRaw = [];
        for (let f of files) {
            $("#loadMsg").text(`Reading: ${f.name}`);
            const data = await extractData(f);
            combinedRaw = combinedRaw.concat(data);
        }

        const recData = combinedRaw.filter(i => i.stat.includes("LMHub_Received") && i.curr.includes(STATIONS.HUB) && i.dest.includes(STATIONS.HUB));
        const ingData = combinedRaw.filter(i => i.stat.includes("SOC_LHTransporting") && i.curr.includes(STATIONS.SOC) && i.dest.includes(STATIONS.HUB));
        const edData  = combinedRaw.filter(i => i.stat.includes("SOC_LHTransported") && i.curr.includes(STATIONS.SOC) && i.dest.includes(STATIONS.HUB));

        const opsPool = [...recData, ...ingData, ...edData];
        const sdoPool = opsPool.filter(i => i.sort.includes("-SDO-"));
        const tvrPool = opsPool.filter(i => i.sort.includes("-TVR-") && !i.sort.includes("-SDO-"));

        const renderTbl = (id, list) => {
            const html = list.map(i => `<tr><td>${i.oid}</td><td>${i.town}</td><td>${i.sort}</td><td>${i.stat}</td><td>${i.curr}</td></tr>`).join('');
            $(id).find('tbody').html(html || '<tr><td colspan="5" class="text-center">No results</td></tr>');
        };

        const renderGrid = (id, list, badge) => {
            let counts = {};
            list.forEach(i => counts[i.town] = (counts[i.town] || 0) + 1);
            let sorted = Object.keys(counts).sort((a,b) => counts[b]-counts[a]);
            $(badge).text(list.length.toLocaleString());
            $(id).html(sorted.map(t => `<div class="town-item ${counts[t] > 50 ? 'hot' : ''}" data-town="${t}"><span>${t}</span><b>${counts[t]}</b></div>`).join(''));
        };

        renderTbl("#t-sdo", sdoPool);
        renderTbl("#t-tvr", tvrPool);
        renderGrid("#grid-sdo", sdoPool, "#q-sdo-p");
        renderGrid("#grid-up", tvrPool.filter(i => UPPER_KEY.some(k => i.town.includes(k))), "#q-up-p");
        renderGrid("#grid-low", tvrPool.filter(i => !UPPER_KEY.some(k => i.town.includes(k))), "#q-low-p");

        $("#c-ops").text(opsPool.length.toLocaleString());
        $("#c-rec").text(recData.length.toLocaleString());
        $("#c-ing").text(ingData.length.toLocaleString());
        $("#c-ed").text(edData.length.toLocaleString());
        $("#c-sdo").text(sdoPool.length.toLocaleString());
        $("#q-sdo-t").text(sdoPool.length.toLocaleString());
        $("#c-tvr").text(tvrPool.length.toLocaleString());
        $("#q-tvr-t").text(tvrPool.length.toLocaleString());

        $("#loadingOverlay").fadeOut();
        $("#file").val('');
    };

    $("#file").on("change", (e) => processFiles(e.target.files));
    $("#tSearch").on("keyup", function() {
        let v = $(this).val().toUpperCase();
        $(".town-item").each(function() { $(this).toggle($(this).data('town').includes(v)); });
    });
});
</script>
</body>
</html>
