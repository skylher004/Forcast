<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Speed Forecast Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85); z-index: 9999;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .stats-card { border-radius: 12px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; background: white; }
        .stats-card:hover { transform: translateY(-3px); }
        .table-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .table-responsive { max-height: 400px; overflow-y: auto; border-radius: 8px; }
        .sticky-thead th { position: sticky; top: 0; background: #212529; color: white; z-index: 10; font-size: 0.85rem; text-transform: uppercase; }
        .section-divider { border-left: 5px solid #0d6efd; padding-left: 15px; margin: 40px 0 20px 0; font-weight: bold; color: #333; text-transform: uppercase; letter-spacing: 1px; }
        .badge-count { font-size: 0.9rem; padding: 0.5em 1em; border-radius: 20px; }
    </style>
</head>
<body>

<div id="loader-overlay">
    <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3 fw-bold text-dark">Updating Dashboard...</h5>
</div>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm">
        <div>
            <h3 class="fw-bold m-0 text-primary">Station Forecast Dashboard</h3>
            <span id="file-name" class="text-muted small">Ready for file upload</span>
        </div>
        <div class="btn-group">
            <input id="file" type="file" accept=".csv, .xlsx, .xls" class="d-none" />
            <button class="btn btn-primary btn-lg px-4 fw-bold" id="upload">UPLOAD EXCEL</button>
            <button class="btn btn-outline-danger" id="clear">RESET</button>
        </div>
    </div>

    <div class="row g-3 mb-4 text-center">
        <div class="col-md-2">
            <div class="card stats-card p-3 border-bottom border-primary border-4">
                <div class="text-muted small fw-bold text-primary mb-1">TOTAL FILTERED</div>
                <h2 id="count-total" class="m-0 fw-bold">0</h2>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card p-3 border-bottom border-success border-4">
                <div class="text-muted small fw-bold text-success mb-1">RECEIVED</div>
                <h2 id="count-received" class="m-0 fw-bold">0</h2>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card p-3 border-bottom border-warning border-4">
                <div class="text-muted small fw-bold text-warning mb-1">TRANSPORTING</div>
                <h2 id="count-transporting" class="m-0 fw-bold">0</h2>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card p-3 border-bottom border-info border-4">
                <div class="text-muted small fw-bold text-info mb-1">TRANSPORTED</div>
                <h2 id="count-transported" class="m-0 fw-bold">0</h2>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card p-3 border-bottom border-primary border-4 bg-light">
                <div class="text-muted small fw-bold text-primary mb-1">TOTAL SDO</div>
                <h2 id="card-total-sdo" class="m-0 fw-bold text-primary">0</h2>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card p-3 border-bottom border-dark border-4 bg-light">
                <div class="text-muted small fw-bold text-dark mb-1">TOTAL TVR</div>
                <h2 id="card-total-tvr" class="m-0 fw-bold text-dark">0</h2>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold text-success m-0">1. LMHUB_RECEIVED (TALAVERA)</h6>
            <span class="badge bg-success badge-count" id="row-count-1">0 Rows</span>
        </div>
        <div class="table-responsive"><table id="table-received" class="table table-hover align-middle"><thead class="sticky-thead"><tr><th>Order ID</th><th>Sort Code</th><th>Town</th><th>Status</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold text-warning m-0">2. SOC_LHTRANSPORTING (SOC 4)</h6>
            <span class="badge bg-warning text-dark badge-count" id="row-count-2">0 Rows</span>
        </div>
        <div class="table-responsive"><table id="table-transporting" class="table table-hover align-middle"><thead class="sticky-thead"><tr><th>Order ID</th><th>Sort Code</th><th>Town</th><th>Status</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold text-info m-0">3. SOC_LHTRANSPORTED (SOC 4)</h6>
            <span class="badge bg-info text-dark badge-count" id="row-count-3">0 Rows</span>
        </div>
        <div class="table-responsive"><table id="table-transported" class="table table-hover align-middle"><thead class="sticky-thead"><tr><th>Order ID</th><th>Sort Code</th><th>Town</th><th>Status</th></tr></thead><tbody></tbody></table></div>
    </div>

    <h4 class="section-divider">Destination Summary</h4>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold text-primary m-0">SANTO DOMINGO (SDO)</h6>
            <span class="badge bg-primary badge-count" id="row-count-sdo">0 Rows</span>
        </div>
        <div class="table-responsive"><table id="table-sdo" class="table table-hover align-middle"><thead class="sticky-thead"><tr><th>Order ID</th><th>Sort Code</th><th>Town</th><th>Status</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold text-dark m-0">TALAVERA (TVR)</h6>
            <span class="badge bg-dark badge-count" id="row-count-tvr">0 Rows</span>
        </div>
        <div class="table-responsive"><table id="table-tvr" class="table table-hover align-middle"><thead class="sticky-thead"><tr><th>Order ID</th><th>Sort Code</th><th>Town</th><th>Status</th></tr></thead><tbody></tbody></table></div>
    </div>
</div>

<script>
$(function () {
    let cachedData = [];

    $("#upload").on("click", function() { $("#file").click(); });
    $("#clear").on("click", function() { location.reload(); });

    $("#file").on("change", function(e) {
        const file = e.target.files[0];
        if (!file) return;
        $("#loader-overlay").css("display", "flex");
        $("#file-name").text("Processing: " + file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            setTimeout(() => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array", raw: true });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rawJson = XLSX.utils.sheet_to_json(sheet, { defval: "" });

                    cachedData = rawJson.map(r => {
                        let row = {};
                        for (let k in r) { row[k.toLowerCase().trim()] = r[k]; }
                        return {
                            oid: row["order id"] || "",
                            sort: String(row["sort code name"] || "").toUpperCase(),
                            town: row["town name"] || "",
                            stat: row["status"] || "",
                            curr: String(row["current station"] || "").trim().toLowerCase(),
                            dest: String(row["destination station"] || "").trim().toLowerCase()
                        };
                    });
                    renderDashboard();
                } catch (err) { alert("Error reading file."); }
                finally { $("#loader-overlay").hide(); }
            }, 100);
        };
        reader.readAsArrayBuffer(file);
    });

    function renderDashboard() {
        const d1 = cachedData.filter(i => i.stat.includes("LMHub_Received") && i.dest.includes("talavera") && i.curr.includes("talavera"));
        const d2 = cachedData.filter(i => i.stat.includes("SOC_LHTransporting") && i.dest.includes("talavera") && i.curr.replace(/\s/g, "") === "soc4");
        const d3 = cachedData.filter(i => i.stat.includes("SOC_LHTransported") && i.dest.includes("talavera") && i.curr.replace(/\s/g, "") === "soc4");

        const combinedFiltered = [...d1, ...d2, ...d3];

        const sdoData = combinedFiltered.filter(i => i.sort.includes("TVR-SDO") || i.sort.includes("TVR-BSC-SDO"));
        const tvrData = combinedFiltered.filter(i => i.sort.includes("TVR-TVR") || i.sort.includes("TVR-S5-BSC-TVR"));

        // Update Top Cards
        $("#count-total").text(combinedFiltered.length);
        $("#count-received").text(d1.length);
        $("#count-transporting").text(d2.length);
        $("#count-transported").text(d3.length);
        $("#card-total-sdo").text(sdoData.length);
        $("#card-total-tvr").text(tvrData.length);

        // Update Badges
        $("#row-count-1").text(d1.length + " Rows");
        $("#row-count-2").text(d2.length + " Rows");
        $("#row-count-3").text(d3.length + " Rows");
        $("#row-count-sdo").text(sdoData.length + " Rows");
        $("#row-count-tvr").text(tvrData.length + " Rows");

        populate("#table-received tbody", d1);
        populate("#table-transporting tbody", d2);
        populate("#table-transported tbody", d3);
        populate("#table-sdo tbody", sdoData);
        populate("#table-tvr tbody", tvrData);
    }

    function populate(selector, list) {
        const tbody = $(selector);
        tbody.empty();
        if (list.length === 0) {
            tbody.append('<tr><td colspan="4" class="text-center text-muted py-4 small">No data found</td></tr>');
            return;
        }
        let html = "";
        list.forEach(i => {
            html += `<tr>
                <td class="fw-bold" style="font-size: 0.85rem;">${i.oid}</td>
                <td><code class="text-primary">${i.sort}</code></td>
                <td>${i.town}</td>
                <td><span class="badge bg-light text-dark border" style="font-size:0.75rem;">${i.stat}</span></td>
            </tr>`;
        });
        tbody.append(html);
    }
});
</script>
</body>
</html>
